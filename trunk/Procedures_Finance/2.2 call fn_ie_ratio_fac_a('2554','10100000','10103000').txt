CREATE PROCEDURE fn_ie_ratio_fac_a(IN paramFnYear VARCHAR(296),IN paramFnOrg VARCHAR(296))
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
   DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
		select ORGENIZATION_SHORT_NAME
		,TypeItemGroup
		,ACTUAL_AMOUNT
		,kmutt.ORGENIZATION_CODE
		from
		(
		SELECT FN_DIM_DEPARTMENT.ORGENIZATION_CODE
		, ORGENIZATION_SHORT_NAME
		, 'ผล' || ITEM_GROUP_NAME as TypeItemGroup
		, CASE WHEN sum(ACTUAL_AMOUNT) < 0 THEN DECIMAL((sum(ACTUAL_AMOUNT)*-1)/1000000,20,0) ELSE DECIMAL(sum(ACTUAL_AMOUNT)/1000000,20,0) END AS ACTUAL_AMOUNT
		, LEVEL_LINE
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '9'
		and (FISCAL_YEAR = (paramFnYear))
		-- and FN_DIM_DEPARTMENT.ORGENIZATION_CODE != 'ไม่ระบุ'
		group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE,ORGENIZATION_SHORT_NAME,ITEM_GROUP_NAME, FN_YEARLY_DEPARTMENT.TEMPLATE_CODE, LEVEL_CODE, LEVEL_LINE
		)kmutt
		left join (
				select  ROWNUMBER() OVER(order by sum(ACTUAL_AMOUNT) desc) AS ROWNUM
				,ORGENIZATION_CODE
				,sum(ACTUAL_AMOUNT) as TotalACTUAL
				from
				(
				SELECT FN_DIM_DEPARTMENT.ORGENIZATION_CODE
				, ORGENIZATION_SHORT_NAME
				, 'ผล' || ITEM_GROUP_NAME as TypeItemGroup
				, CASE WHEN sum(ACTUAL_AMOUNT) < 0 THEN DECIMAL(sum(ACTUAL_AMOUNT)*-1,20,0) ELSE DECIMAL(sum(ACTUAL_AMOUNT),20,0) END AS ACTUAL_AMOUNT
				, LEVEL_LINE
				FROM FN_YEARLY_DEPARTMENT
				left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
				left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
				where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '9'
				and (FISCAL_YEAR = (paramFnYear))
				-- and FN_DIM_DEPARTMENT.ORGENIZATION_CODE != 'ไม่ระบุ'
				and AREA_CODE = 01
				and ORGENIZATION_NAME LIKE ('คณะ%')
				group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE,ORGENIZATION_SHORT_NAME,ITEM_GROUP_NAME, FN_YEARLY_DEPARTMENT.TEMPLATE_CODE, LEVEL_CODE, LEVEL_LINE
				)kmutt
				group by ORGENIZATION_CODE
		)total on total.ORGENIZATION_CODE = kmutt.ORGENIZATION_CODE
		where ROWNUM is not null
		and ACTUAL_AMOUNT != 0
		order by LEVEL_LINE , ROWNUM desc
	;               
		
	DECLARE result_set_2 CURSOR WITH RETURN TO CLIENT FOR
		select ORGENIZATION_SHORT_NAME
		,TypeItemGroup
		,ACTUAL_AMOUNT
		,kmutt.ORGENIZATION_CODE
		from
		(
		SELECT FN_DIM_DEPARTMENT.ORGENIZATION_CODE
		, ORGENIZATION_SHORT_NAME
		, 'ผล' || ITEM_GROUP_NAME as TypeItemGroup
		, CASE WHEN sum(ACTUAL_AMOUNT) < 0 THEN DECIMAL((sum(ACTUAL_AMOUNT)*-1)/1000000,20,0) ELSE DECIMAL(sum(ACTUAL_AMOUNT)/1000000,20,0) END AS ACTUAL_AMOUNT
		, LEVEL_LINE
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '9'
		and (FISCAL_YEAR = (paramFnYear))
		-- and FN_DIM_DEPARTMENT.ORGENIZATION_CODE != 'ไม่ระบุ'
		group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE,ORGENIZATION_SHORT_NAME,ITEM_GROUP_NAME, FN_YEARLY_DEPARTMENT.TEMPLATE_CODE, LEVEL_CODE, LEVEL_LINE
		)kmutt
		left join (
				select  ROWNUMBER() OVER(order by sum(ACTUAL_AMOUNT) desc) AS ROWNUM
				,ORGENIZATION_CODE
				,sum(ACTUAL_AMOUNT) as TotalACTUAL
				from
				(
					SELECT FN_DIM_DEPARTMENT.ORGENIZATION_CODE
					, ORGENIZATION_SHORT_NAME
					, 'ผล' || ITEM_GROUP_NAME as TypeItemGroup
					, CASE WHEN sum(ACTUAL_AMOUNT) < 0 THEN DECIMAL(sum(ACTUAL_AMOUNT)*-1,20,0) ELSE DECIMAL(sum(ACTUAL_AMOUNT),20,0) END AS ACTUAL_AMOUNT
					, LEVEL_LINE
					FROM FN_YEARLY_DEPARTMENT
					left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
					left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
					where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '9'
					and (FISCAL_YEAR = (paramFnYear))
					-- and FN_DIM_DEPARTMENT.ORGENIZATION_CODE != 'ไม่ระบุ'
					and AREA_CODE = 01
					and ORGENIZATION_NAME LIKE ('คณะ%')
					group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE,ORGENIZATION_SHORT_NAME,ITEM_GROUP_NAME, FN_YEARLY_DEPARTMENT.TEMPLATE_CODE, LEVEL_CODE, LEVEL_LINE
				)kmutt
				group by ORGENIZATION_CODE
		)total on total.ORGENIZATION_CODE = kmutt.ORGENIZATION_CODE
		where (kmutt.ORGENIZATION_CODE = (paramFnOrg))
		order by LEVEL_LINE , ROWNUM desc
	;        	
		
     IF (paramFnOrg) = 'All' THEN
        OPEN  result_set_1;
     ELSE
        OPEN  result_set_2;
     END IF;
END