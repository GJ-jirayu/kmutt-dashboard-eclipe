CREATE PROCEDURE fn_cost_ratio_year_b(IN paramFnYear VARCHAR(256),IN paramFnOrg VARCHAR(256),IN paramFnDep VARCHAR(256)) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
		
	                
		select CASE WHEN sum(EXP_AMOUNT) = 0 THEN 0 ELSE DECIMAL((sum(REC_AMOUNT) / sum(EXP_AMOUNT))*100,20,2) END AS REC_EXP
		from 
		(
		SELECT CASE WHEN sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT) < 0 THEN DECIMAL((sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)*-1)/1000000,20,0) ELSE DECIMAL(sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)/1000000,20,0) END AS REC_AMOUNT
		, '0' as EXP_AMOUNT
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
		and (LEVEL_LINE in ('2'))
        and (FISCAL_YEAR = (paramFnYear))
        and (ORGENIZATION_CODE in (paramFnOrg) or 'All' in (paramFnOrg))
        and (DEPARTMENT_CODE in (paramFnDep) or 'All' in (paramFnDep))

		union

		SELECT '0' as REC_AMOUNT
		, CASE WHEN sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT) < 0 THEN DECIMAL((sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)*-1)/1000000,20,0) ELSE DECIMAL(sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)/1000000,20,0) END AS EXP_AMOUNT
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
		and (LEVEL_LINE in ('2','3'))
        and (FISCAL_YEAR = (paramFnYear))
        and (ORGENIZATION_CODE in (paramFnOrg) or 'All' in (paramFnOrg))
        and (DEPARTMENT_CODE in (paramFnDep) or 'All' in (paramFnDep))
		)kmutt
		
	;        	
    OPEN  result_set_1;
END