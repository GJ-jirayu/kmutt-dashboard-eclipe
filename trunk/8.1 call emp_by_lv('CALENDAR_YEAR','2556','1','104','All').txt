CREATE PROCEDURE emp_by_lv(IN paramEmpTypeYear VARCHAR(256),IN paramEmpYear VARCHAR(256),IN paramEmpTypeGroup VARCHAR(256),IN paramEmpLineGroup VARCHAR(256),IN paramEmpDep VARCHAR(256)) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
		select AGE_RANGE_DESC
		,SUB_LEVEL_NAME
		,sum(total) as total
		-- ,ORDER_BY_SUB_LEVEL
		-- ,TGTY_CODE
		-- ,TGTY_NAME
		-- ,LineCN
		-- ,LineGroupCN
		-- ,ORGENIZATION_NAME_B
		from
			(		
			SELECT AGE_RANGE_DESC
			, SUB_LEVEL_NAME
			, count(distinct EMP_KEY) as total
			, ORDER_BY_SUB_LEVEL
			, EMP_TYPE_Code || EMP_GROUP_CODE || EMP_TYPE_GROUP_CODE as TGTY_CODE
			, EMP_TYPE_NAME ||' '|| EMP_GROUP_NAME ||' '|| EMP_TYPE_GROUP_NAME as TGTY_NAME
			, EMP_LINE_CODE
			, EMP_LINE_CODE ||' '|| EMP_LINE_NAME as LineCN
			, EMP_LINE_GROUP_CODE
			, EMP_LINE_GROUP_CODE ||' '|| EMP_LINE_GROUP_NAME as LineGroupCN
			FROM HR_FACT_EMPLOYEE
			left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_EMPLOYEE.MONTH_KEY
			left join HR_DIM_LEVEL on HR_DIM_LEVEL.LEVEL_KEY = HR_FACT_EMPLOYEE.LEVEL_KEY
			left join HR_DIM_AGE_RANGE on HR_DIM_AGE_RANGE.AGE_RANGE_KEY = HR_FACT_EMPLOYEE.AGE_RANGE_KEY
			left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_EMPLOYEE.POSITION_GROUP_KEY
			left join HR_DIM_EMP_TYPE on HR_DIM_EMP_TYPE.EMP_TYPE_KEY = HR_FACT_EMPLOYEE.EMP_TYPE_KEY
			left join HR_DIM_EMP_LINE_GROUP on HR_DIM_EMP_LINE_GROUP.EMP_LINE_GROUP_KEY = HR_FACT_EMPLOYEE.EMP_LINE_KEY
			left join HR_DIM_DEPARTMENT on HR_DIM_DEPARTMENT.DEPARTMENT_KEY = HR_FACT_EMPLOYEE.DEPARTMENT_KEY
			where (EMP_TYPE_GROUP_CODE in ('1','2','3','4'))
			and (EMP_GROUP_CODE in ('1','2','3'))
			and (EMP_TYPE_CODE in ('1','2','6'))
			and (DIM_DATE.CALENDAR_YEAR = (paramEmpYear))
			and (ORGENIZATION_NAME_B in (paramEmpDep) or 'All' in (paramEmpDep))
			group by AGE_RANGE_DESC
			, SUB_LEVEL_NAME
			, ORDER_BY_SUB_LEVEL
			, EMP_TYPE_Code || EMP_GROUP_CODE || EMP_TYPE_GROUP_CODE
			, EMP_TYPE_NAME ||' '|| EMP_GROUP_NAME ||' '|| EMP_TYPE_GROUP_NAME
			, EMP_LINE_CODE
			, EMP_LINE_CODE ||' '|| EMP_LINE_NAME
			, EMP_LINE_GROUP_CODE
			, EMP_LINE_GROUP_CODE ||' '|| EMP_LINE_GROUP_NAME
		)kmutt 
		where (TGTY_CODE = paramEmpTypeGroup)
		and (EMP_LINE_GROUP_CODE in (paramEmpLineGroup) or 'All' in (paramEmpLineGroup))
		-- and (EMP_LINE_CODE = paramEmpLineGroup)
		group by AGE_RANGE_DESC
		,SUB_LEVEL_NAME
		,ORDER_BY_SUB_LEVEL
		order by ORDER_BY_SUB_LEVEL,AGE_RANGE_DESC		
	;               
		
	DECLARE result_set_2 CURSOR WITH RETURN TO CLIENT FOR
		
		select AGE_RANGE_DESC
		,SUB_LEVEL_NAME
		,sum(total) as total
		-- ,ORDER_BY_SUB_LEVEL
		-- ,TGTY_CODE
		-- ,TGTY_NAME
		-- ,LineCN
		-- ,LineGroupCN
		-- ,ORGENIZATION_NAME_B
		from
			(		
			SELECT AGE_RANGE_DESC
			, SUB_LEVEL_NAME
			, count(distinct EMP_KEY) as total
			, ORDER_BY_SUB_LEVEL
			, EMP_TYPE_Code || EMP_GROUP_CODE || EMP_TYPE_GROUP_CODE as TGTY_CODE
			, EMP_TYPE_NAME ||' '|| EMP_GROUP_NAME ||' '|| EMP_TYPE_GROUP_NAME as TGTY_NAME
			, EMP_LINE_CODE
			, EMP_LINE_CODE ||' '|| EMP_LINE_NAME as LineCN
			, EMP_LINE_GROUP_CODE
			, EMP_LINE_GROUP_CODE ||' '|| EMP_LINE_GROUP_NAME as LineGroupCN
			FROM HR_FACT_EMPLOYEE
			left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_EMPLOYEE.MONTH_KEY
			left join HR_DIM_LEVEL on HR_DIM_LEVEL.LEVEL_KEY = HR_FACT_EMPLOYEE.LEVEL_KEY
			left join HR_DIM_AGE_RANGE on HR_DIM_AGE_RANGE.AGE_RANGE_KEY = HR_FACT_EMPLOYEE.AGE_RANGE_KEY
			left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_EMPLOYEE.POSITION_GROUP_KEY
			left join HR_DIM_EMP_TYPE on HR_DIM_EMP_TYPE.EMP_TYPE_KEY = HR_FACT_EMPLOYEE.EMP_TYPE_KEY
			left join HR_DIM_EMP_LINE_GROUP on HR_DIM_EMP_LINE_GROUP.EMP_LINE_GROUP_KEY = HR_FACT_EMPLOYEE.EMP_LINE_KEY
			left join HR_DIM_DEPARTMENT on HR_DIM_DEPARTMENT.DEPARTMENT_KEY = HR_FACT_EMPLOYEE.DEPARTMENT_KEY
			where (EMP_TYPE_GROUP_CODE in ('1','2','3','4'))
			and (EMP_GROUP_CODE in ('1','2','3'))
			and (EMP_TYPE_CODE in ('1','2','6'))
			and (DIM_DATE.FISCAL_YEAR = (paramEmpYear))
			and (ORGENIZATION_NAME_B in (paramEmpDep) or 'All' in (paramEmpDep))
			group by AGE_RANGE_DESC
			, SUB_LEVEL_NAME
			, ORDER_BY_SUB_LEVEL
			, EMP_TYPE_Code || EMP_GROUP_CODE || EMP_TYPE_GROUP_CODE
			, EMP_TYPE_NAME ||' '|| EMP_GROUP_NAME ||' '|| EMP_TYPE_GROUP_NAME
			, EMP_LINE_CODE
			, EMP_LINE_CODE ||' '|| EMP_LINE_NAME
			, EMP_LINE_GROUP_CODE
			, EMP_LINE_GROUP_CODE ||' '|| EMP_LINE_GROUP_NAME
		)kmutt 
		where (TGTY_CODE = paramEmpTypeGroup)
		and (EMP_LINE_GROUP_CODE in (paramEmpLineGroup) or 'All' in (paramEmpLineGroup))
		-- and (EMP_LINE_CODE = paramEmpLineGroup)
		group by AGE_RANGE_DESC
		,SUB_LEVEL_NAME
		,ORDER_BY_SUB_LEVEL
		order by ORDER_BY_SUB_LEVEL,AGE_RANGE_DESC
		
	;
		
    DECLARE result_set_3 CURSOR WITH RETURN TO CLIENT FOR
		
		select AGE_RANGE_DESC
		,SUB_LEVEL_NAME
		,sum(total) as total
		-- ,ORDER_BY_SUB_LEVEL
		-- ,TGTY_CODE
		-- ,TGTY_NAME
		-- ,LineCN
		-- ,LineGroupCN
		-- ,ORGENIZATION_NAME_B
		from
			(		
			SELECT AGE_RANGE_DESC
			, SUB_LEVEL_NAME
			, count(distinct EMP_KEY) as total
			, ORDER_BY_SUB_LEVEL
			, EMP_TYPE_Code || EMP_GROUP_CODE || EMP_TYPE_GROUP_CODE as TGTY_CODE
			, EMP_TYPE_NAME ||' '|| EMP_GROUP_NAME ||' '|| EMP_TYPE_GROUP_NAME as TGTY_NAME
			, EMP_LINE_CODE
			, EMP_LINE_CODE ||' '|| EMP_LINE_NAME as LineCN
			, EMP_LINE_GROUP_CODE
			, EMP_LINE_GROUP_CODE ||' '|| EMP_LINE_GROUP_NAME as LineGroupCN
			FROM HR_FACT_EMPLOYEE
			left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_EMPLOYEE.MONTH_KEY
			left join HR_DIM_LEVEL on HR_DIM_LEVEL.LEVEL_KEY = HR_FACT_EMPLOYEE.LEVEL_KEY
			left join HR_DIM_AGE_RANGE on HR_DIM_AGE_RANGE.AGE_RANGE_KEY = HR_FACT_EMPLOYEE.AGE_RANGE_KEY
			left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_EMPLOYEE.POSITION_GROUP_KEY
			left join HR_DIM_EMP_TYPE on HR_DIM_EMP_TYPE.EMP_TYPE_KEY = HR_FACT_EMPLOYEE.EMP_TYPE_KEY
			left join HR_DIM_EMP_LINE_GROUP on HR_DIM_EMP_LINE_GROUP.EMP_LINE_GROUP_KEY = HR_FACT_EMPLOYEE.EMP_LINE_KEY
			left join HR_DIM_DEPARTMENT on HR_DIM_DEPARTMENT.DEPARTMENT_KEY = HR_FACT_EMPLOYEE.DEPARTMENT_KEY
			where (EMP_TYPE_GROUP_CODE in ('1','2','3','4'))
			and (EMP_GROUP_CODE in ('1','2','3'))
			and (EMP_TYPE_CODE in ('1','2','6'))
			and (DIM_DATE.ACADAMIC_YEAR = (paramEmpYear))
			and (ORGENIZATION_NAME_B in (paramEmpDep) or 'All' in (paramEmpDep))
			group by AGE_RANGE_DESC
			, SUB_LEVEL_NAME
			, ORDER_BY_SUB_LEVEL
			, EMP_TYPE_Code || EMP_GROUP_CODE || EMP_TYPE_GROUP_CODE
			, EMP_TYPE_NAME ||' '|| EMP_GROUP_NAME ||' '|| EMP_TYPE_GROUP_NAME
			, EMP_LINE_CODE
			, EMP_LINE_CODE ||' '|| EMP_LINE_NAME
			, EMP_LINE_GROUP_CODE
			, EMP_LINE_GROUP_CODE ||' '|| EMP_LINE_GROUP_NAME
		)kmutt 
		where (TGTY_CODE = paramEmpTypeGroup)
		and (EMP_LINE_GROUP_CODE in (paramEmpLineGroup) or 'All' in (paramEmpLineGroup))
		-- and (EMP_LINE_CODE = paramEmpLineGroup)
		group by AGE_RANGE_DESC
		,SUB_LEVEL_NAME
		,ORDER_BY_SUB_LEVEL
		order by ORDER_BY_SUB_LEVEL,AGE_RANGE_DESC
		
	;        	
		
     IF (paramEmpTypeYear) = 'CALENDAR_YEAR' THEN
        OPEN  result_set_1;
     ELSEIF(paramEmpTypeYear) = 'FISCAL_YEAR' THEN
        OPEN  result_set_2;
     ELSE
        OPEN  result_set_3;
     END IF;
END