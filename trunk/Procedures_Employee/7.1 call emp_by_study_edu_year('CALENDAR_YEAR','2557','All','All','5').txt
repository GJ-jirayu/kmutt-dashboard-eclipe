CREATE PROCEDURE emp_by_study_edu_year(IN paramEmpTypeYear VARCHAR(256),IN paramEmpYear VARCHAR(256),IN paramEmpPos VARCHAR(256),IN paramEmpEdu VARCHAR(256),IN paramEmpYearSub VARCHAR(256)) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
		SELECT DIM_DATE.CALENDAR_YEAR
		, HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME
		,CASE WHEN total.TOTAL_STUDY != 0 THEN DECIMAL(((DECIMAL(sum(CALENDAR_NO_OF_STUDY),8,2) * 100)/total.TOTAL_STUDY),8,2) ELSE 0 END AS total_NO_OF_STUDY
		FROM HR_FACT_STUDY
		left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_STUDY.MONTH_KEY
		left join HR_DIM_EDUCATION_LEVEL on HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = HR_FACT_STUDY.EDUCATION_LEVEL_KEY
		left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_STUDY.POSITION_GROUP_KEY
		left join (
						SELECT CALENDAR_YEAR
						, sum(CALENDAR_NO_OF_STUDY) as TOTAL_STUDY
						FROM HR_FACT_STUDY
						left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_STUDY.MONTH_KEY
						left join HR_DIM_EDUCATION_LEVEL on HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = HR_FACT_STUDY.EDUCATION_LEVEL_KEY
						left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_STUDY.POSITION_GROUP_KEY
						where (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('41','42','43','44','96'))
						and (DIM_DATE.CALENDAR_YEAR between (paramEmpYear)-(paramEmpYearSub)+(1) and (paramEmpYear))
						and (HR_DIM_POSITION_GROUP.POSITION_GROUP_CODE in (paramEmpPos) or 'All' in (paramEmpPos))
						and (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in (paramEmpEdu) or 'All' in (paramEmpEdu))
						group by CALENDAR_YEAR
					)total on total.CALENDAR_YEAR = DIM_DATE.CALENDAR_YEAR
		where (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('41','42','43','44','96'))
		and (DIM_DATE.CALENDAR_YEAR between (paramEmpYear)-(paramEmpYearSub)+(1) and (paramEmpYear))
		and (HR_DIM_POSITION_GROUP.POSITION_GROUP_CODE in (paramEmpPos) or 'All' in (paramEmpPos))
		and (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in (paramEmpEdu) or 'All' in (paramEmpEdu))
		group by DIM_DATE.CALENDAR_YEAR, HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE,HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME,total.TOTAL_STUDY
		order by HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE
	;               
		
	DECLARE result_set_2 CURSOR WITH RETURN TO CLIENT FOR
		SELECT DIM_DATE.FISCAL_YEAR
		, HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME
		,CASE WHEN total.TOTAL_STUDY != 0 THEN DECIMAL(((DECIMAL(sum(CALENDAR_NO_OF_STUDY),8,2) * 100)/total.TOTAL_STUDY),8,2) ELSE 0 END AS total_NO_OF_STUDY
		FROM HR_FACT_STUDY
		left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_STUDY.MONTH_KEY
		left join HR_DIM_EDUCATION_LEVEL on HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = HR_FACT_STUDY.EDUCATION_LEVEL_KEY
		left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_STUDY.POSITION_GROUP_KEY
		left join (
						SELECT FISCAL_YEAR
						, sum(CALENDAR_NO_OF_STUDY) as TOTAL_STUDY
						FROM HR_FACT_STUDY
						left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_STUDY.MONTH_KEY
						left join HR_DIM_EDUCATION_LEVEL on HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = HR_FACT_STUDY.EDUCATION_LEVEL_KEY
						left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_STUDY.POSITION_GROUP_KEY
						where (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('41','42','43','44','96'))
						and (DIM_DATE.FISCAL_YEAR between (paramEmpYear)-(paramEmpYearSub)+(1) and (paramEmpYear))
						and (HR_DIM_POSITION_GROUP.POSITION_GROUP_CODE in (paramEmpPos) or 'All' in (paramEmpPos))
						and (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in (paramEmpEdu) or 'All' in (paramEmpEdu))
						group by FISCAL_YEAR
					)total on total.FISCAL_YEAR = DIM_DATE.FISCAL_YEAR
		where (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('41','42','43','44','96'))
		and (DIM_DATE.FISCAL_YEAR between (paramEmpYear)-(paramEmpYearSub)+(1) and (paramEmpYear))
		and (HR_DIM_POSITION_GROUP.POSITION_GROUP_CODE in (paramEmpPos) or 'All' in (paramEmpPos))
		and (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in (paramEmpEdu) or 'All' in (paramEmpEdu))
		group by DIM_DATE.FISCAL_YEAR, HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE,HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME,total.TOTAL_STUDY
		order by HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE	
	;
		
    DECLARE result_set_3 CURSOR WITH RETURN TO CLIENT FOR
		SELECT DIM_DATE.ACADAMIC_YEAR
		, HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME
		,CASE WHEN total.TOTAL_STUDY != 0 THEN DECIMAL(((DECIMAL(sum(CALENDAR_NO_OF_STUDY),8,2) * 100)/total.TOTAL_STUDY),8,2) ELSE 0 END AS total_NO_OF_STUDY
		FROM HR_FACT_STUDY
		left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_STUDY.MONTH_KEY
		left join HR_DIM_EDUCATION_LEVEL on HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = HR_FACT_STUDY.EDUCATION_LEVEL_KEY
		left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_STUDY.POSITION_GROUP_KEY
		left join (
						SELECT ACADAMIC_YEAR
						, sum(CALENDAR_NO_OF_STUDY) as TOTAL_STUDY
						FROM HR_FACT_STUDY
						left join DIM_DATE on DIM_DATE.DATE_KEY = HR_FACT_STUDY.MONTH_KEY
						left join HR_DIM_EDUCATION_LEVEL on HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = HR_FACT_STUDY.EDUCATION_LEVEL_KEY
						left join HR_DIM_POSITION_GROUP on HR_DIM_POSITION_GROUP.POSITION_GROUP_KEY = HR_FACT_STUDY.POSITION_GROUP_KEY
						where (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('41','42','43','44','96'))
						and (DIM_DATE.ACADAMIC_YEAR between (paramEmpYear)-(paramEmpYearSub)+(1) and (paramEmpYear))
						and (HR_DIM_POSITION_GROUP.POSITION_GROUP_CODE in (paramEmpPos) or 'All' in (paramEmpPos))
						and (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in (paramEmpEdu) or 'All' in (paramEmpEdu))
						group by ACADAMIC_YEAR
					)total on total.ACADAMIC_YEAR = DIM_DATE.ACADAMIC_YEAR
		where (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('41','42','43','44','96'))
		and (DIM_DATE.ACADAMIC_YEAR between (paramEmpYear)-(paramEmpYearSub)+(1) and (paramEmpYear))
		and (HR_DIM_POSITION_GROUP.POSITION_GROUP_CODE in (paramEmpPos) or 'All' in (paramEmpPos))
		and (HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in (paramEmpEdu) or 'All' in (paramEmpEdu))
		group by DIM_DATE.ACADAMIC_YEAR, HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE,HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME,total.TOTAL_STUDY
		order by HR_DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE		
	;        	
		
     IF (paramEmpTypeYear) = 'CALENDAR_YEAR' THEN
        OPEN  result_set_1;
     ELSEIF(paramEmpTypeYear) = 'FISCAL_YEAR' THEN
        OPEN  result_set_2;
     ELSE
        OPEN  result_set_3;
     END IF;
END