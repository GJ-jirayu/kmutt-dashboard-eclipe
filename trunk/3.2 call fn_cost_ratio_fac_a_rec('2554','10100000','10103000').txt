CREATE PROCEDURE fn_cost_ratio_fac_a_rec(IN paramFnYear integer,IN paramFnOrg VARCHAR(256)) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
   DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
		select ORGENIZATION_SHORT_NAME
		,TypeItemGroup
		,ACTUAL_AMOUNT
		,ORGENIZATION_CODE
		from 
		(
		SELECT FN_DIM_DEPARTMENT.ORGENIZATION_CODE
		, FN_DIM_DEPARTMENT.ORGENIZATION_SHORT_NAME
		, 'ผล' || ITEM_GROUP_NAME as TypeItemGroup
		, CASE WHEN sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT) < 0 THEN DECIMAL((sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)*-1)/1000000,20,0) ELSE DECIMAL(sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)/1000000,20,0) END AS ACTUAL_AMOUNT
		, ROWNUM
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		left join (
				SELECT ROWNUMBER() OVER(order by sum(ACTUAL_AMOUNT) desc) AS ROWNUM
				, FN_DIM_DEPARTMENT.ORGENIZATION_CODE
				, CASE WHEN sum(ACTUAL_AMOUNT) < 0 THEN DECIMAL(sum(ACTUAL_AMOUNT)*-1,20,0) ELSE DECIMAL(sum(ACTUAL_AMOUNT),20,0) END AS ACTUAL_AMOUNT
				FROM FN_YEARLY_DEPARTMENT
				left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
				left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
				where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
				and (FISCAL_YEAR = (paramFnYear))
				and AREA_CODE = 01
				and ORGENIZATION_NAME LIKE ('คณะ%')
				group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE
		)maxrow on FN_DIM_DEPARTMENT.ORGENIZATION_CODE = maxrow.ORGENIZATION_CODE
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
		and (FISCAL_YEAR = (paramFnYear))
		and (LEVEL_LINE in ('2'))
		and ROWNUM is not null
		group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE,ORGENIZATION_SHORT_NAME,ITEM_GROUP_NAME,ROWNUM

		union

		SELECT FN_DIM_DEPARTMENT.ORGENIZATION_CODE
		, FN_DIM_DEPARTMENT.ORGENIZATION_SHORT_NAME
		, 'ผลค่าใช้จ่ายดำเนินการ' as TypeItemGroup
		, CASE WHEN sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT) < 0 THEN DECIMAL((sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)*-1)/1000000,20,0) ELSE DECIMAL(sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)/1000000,20,0) END AS ACTUAL_AMOUNT
		, ROWNUM
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		left join (
				SELECT ROWNUMBER() OVER(order by sum(ACTUAL_AMOUNT) desc) AS ROWNUM
				, FN_DIM_DEPARTMENT.ORGENIZATION_CODE
				, CASE WHEN sum(ACTUAL_AMOUNT) < 0 THEN DECIMAL(sum(ACTUAL_AMOUNT)*-1,20,0) ELSE DECIMAL(sum(ACTUAL_AMOUNT),20,0) END AS ACTUAL_AMOUNT
				FROM FN_YEARLY_DEPARTMENT
				left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
				left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
				where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
				and (FISCAL_YEAR = (paramFnYear))
				and AREA_CODE = 01
				and ORGENIZATION_NAME LIKE ('คณะ%')
				group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE
		)maxrow on FN_DIM_DEPARTMENT.ORGENIZATION_CODE = maxrow.ORGENIZATION_CODE
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
		and (FISCAL_YEAR = (paramFnYear))
		and (LEVEL_LINE in ('2','3'))
		and ROWNUM is not null
		group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE,ORGENIZATION_SHORT_NAME,ROWNUM
		)kmutt
		order by TypeItemGroup desc,ROWNUM desc
	;               
		
	DECLARE result_set_2 CURSOR WITH RETURN TO CLIENT FOR
		select ORGENIZATION_SHORT_NAME
		,TypeItemGroup
		,ACTUAL_AMOUNT
		,ORGENIZATION_CODE
		from 
		(
		SELECT FN_DIM_DEPARTMENT.ORGENIZATION_CODE
		, FN_DIM_DEPARTMENT.ORGENIZATION_SHORT_NAME
		, 'ผล' || ITEM_GROUP_NAME as TypeItemGroup
		, CASE WHEN sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT) < 0 THEN DECIMAL((sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)*-1)/1000000,20,0) ELSE DECIMAL(sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)/1000000,20,0) END AS ACTUAL_AMOUNT
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
		and (FISCAL_YEAR = (paramFnYear))
		and (LEVEL_LINE in ('2'))
		group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE,ORGENIZATION_SHORT_NAME,ITEM_GROUP_NAME

		union

		SELECT FN_DIM_DEPARTMENT.ORGENIZATION_CODE
		, FN_DIM_DEPARTMENT.ORGENIZATION_SHORT_NAME
		, 'ผลค่าใช้จ่ายดำเนินการ' as TypeItemGroup
		, CASE WHEN sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT) < 0 THEN DECIMAL((sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)*-1)/1000000,20,0) ELSE DECIMAL(sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT)/1000000,20,0) END AS ACTUAL_AMOUNT
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
		and (FISCAL_YEAR = (paramFnYear))
		and (LEVEL_LINE in ('2','3'))
		group by FN_DIM_DEPARTMENT.ORGENIZATION_CODE,ORGENIZATION_SHORT_NAME
		)kmutt
		where (ORGENIZATION_CODE = paramFnOrg)
		order by TypeItemGroup desc
	;        	
		
     IF (paramFnOrg) = 'All' THEN
        OPEN  result_set_1;
     ELSE
        OPEN  result_set_2;
     END IF;
END