CREATE PROCEDURE p_all_student_by_education_level_and_student_type(IN paramYEAR INTEGER,IN paramSEMESTER VARCHAR(256),IN paramFOREIGN VARCHAR(256),IN paramEDU VARCHAR(256)) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR

select EDUCATION_LEVEL_NAME
,FOREIGN_FLAG_NAME
,TOTELACTUALPLAN
from
(SELECT DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME
,'นักศึกษาไทย' as FOREIGN_FLAG_NAME
,sum(FACT_ACTUAL_PLAN.NO_OF_ACTUAL_STUDENT) as TOTELACTUALPLAN
,DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE
,DIM_FOREIGN_FLAG.FOREIGN_FLAG
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ACTUAL_PLAN.FIELD_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_FOREIGN_FLAG.FOREIGN_FLAG = 'N')
and (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
group by DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME
,DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE
,DIM_FOREIGN_FLAG.FOREIGN_FLAG
union
SELECT DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME
,'นักศึกษาต่างชาติ' as FOREIGN_FLAG_NAME
,sum(FACT_ACTUAL_PLAN.NO_OF_ACTUAL_STUDENT) as TOTELACTUALPLAN
,DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE
,DIM_FOREIGN_FLAG.FOREIGN_FLAG
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ACTUAL_PLAN.FIELD_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_FOREIGN_FLAG.FOREIGN_FLAG = 'Y')
and (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
group by DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_NAME
,DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE
,DIM_FOREIGN_FLAG.FOREIGN_FLAG
)ACTUAL_PLAN
where (FOREIGN_FLAG in (paramFOREIGN) or 'All' in (paramFOREIGN))
order by FOREIGN_FLAG,EDUCATION_LEVEL_CODE
;
    OPEN result_set_1;
END