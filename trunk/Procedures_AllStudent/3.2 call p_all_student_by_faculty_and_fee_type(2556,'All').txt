CREATE PROCEDURE p_all_student_by_faculty_and_fee_type(IN paramYEAR INTEGER,IN paramSEMESTER VARCHAR(256),IN paramEDU VARCHAR(256)) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
	
select case when FACULTY_NAME_INITIAL = 'KMUTT' then 'อื่นๆ' else FACULTY_NAME_INITIAL end as FACULTY_NAME_INITIAL
,FEE_TYPE
,Totale_student
,nos
from 
(select gj.FACULTY_NAME_INITIAL
,gj.FEE_TYPE
,CASE WHEN gj2.no_student != 0 THEN DECIMAL(((DECIMAL(gj.no_of_student,8,2) * 100)/gj2.no_student),8,2) ELSE 0 END AS Totale_student
,'1' as nos
from
(select DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_PROGRAM.FEE_TYPE
,sum(no_of_student) as no_of_student
from FACT_ALL_STUDENT 
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ALL_STUDENT.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ALL_STUDENT.PROGRAM_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ALL_STUDENT.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_PROGRAM.FEE_TYPE not in ('N/A'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_PROGRAM.FEE_TYPE
)gj
left join (
	select DIM_FACULTY.FACULTY_CODE
,sum(no_of_student) as no_student
from FACT_ALL_STUDENT 
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ALL_STUDENT.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ALL_STUDENT.PROGRAM_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ALL_STUDENT.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_PROGRAM.FEE_TYPE not in ('N/A'))
group by DIM_FACULTY.FACULTY_CODE
)gj2 on gj2.FACULTY_CODE = gj.FACULTY_CODE
where gj.no_of_student not in ('0')

union

select gj.FACULTY_NAME_INITIAL
,gj.FEE_TYPE
,CASE WHEN gj2.no_student != 0 THEN DECIMAL(((DECIMAL(gj.no_of_student,8,2) * 100)/gj2.no_student),8,2) ELSE 0 END AS Totale_student
,'2' as nos
from
(select DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_PROGRAM.FEE_TYPE
,sum(no_of_student) as no_of_student
from FACT_ALL_STUDENT 
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ALL_STUDENT.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ALL_STUDENT.PROGRAM_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ALL_STUDENT.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_PROGRAM.FEE_TYPE in ('N/A'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_PROGRAM.FEE_TYPE
)gj
left join (
	select DIM_FACULTY.FACULTY_CODE
,sum(no_of_student) as no_student
from FACT_ALL_STUDENT 
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ALL_STUDENT.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ALL_STUDENT.PROGRAM_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ALL_STUDENT.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_PROGRAM.FEE_TYPE in ('N/A'))
group by DIM_FACULTY.FACULTY_CODE
)gj2 on gj2.FACULTY_CODE = gj.FACULTY_CODE
where gj.no_of_student not in ('0')
)gj
order by nos,FEE_TYPE;

    OPEN result_set_1;
END