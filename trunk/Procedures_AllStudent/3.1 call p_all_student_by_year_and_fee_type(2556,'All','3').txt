CREATE PROCEDURE p_all_student_by_year_and_fee_type(IN paramYEAR INTEGER,IN paramSEMESTER VARCHAR(256),IN paramEDU VARCHAR(256),IN paramYEARSUB VARCHAR(256)) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
	
select ACADEMIC_YEAR
,FEE_TYPE
,no_of_student
from
(
select DIM_SEMESTER.ACADEMIC_YEAR
,DIM_PROGRAM.FEE_TYPE
,sum(no_of_student) as no_of_student
from FACT_ALL_STUDENT 
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ALL_STUDENT.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ALL_STUDENT.PROGRAM_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR between (paramYEAR)-(paramYEARSUB)+(1) and (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_PROGRAM.FEE_TYPE not in ('N/A'))
group by DIM_SEMESTER.ACADEMIC_YEAR,DIM_PROGRAM.FEE_TYPE

union

select DIM_SEMESTER.ACADEMIC_YEAR
,DIM_PROGRAM.FEE_TYPE
,sum(no_of_student) as no_of_student
from FACT_ALL_STUDENT 
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ALL_STUDENT.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ALL_STUDENT.PROGRAM_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR between (paramYEAR)-(paramYEARSUB)+(1) and (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_PROGRAM.FEE_TYPE in ('N/A'))
group by DIM_SEMESTER.ACADEMIC_YEAR,DIM_PROGRAM.FEE_TYPE
)gj;
	
    OPEN result_set_1;
END