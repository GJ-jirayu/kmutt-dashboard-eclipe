CREATE PROCEDURE fn_cost_ratio_dep_a_code_rec(IN paramFnYear integer,IN paramFnOrg VARCHAR(256),IN paramFnDep VARCHAR(256)) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
		
	   select DEPARTMENT_CODE
		,TypeItemGroup
		,DECIMAL(ACTUAL_AMOUNT/1000000,20,2)
		from 
		(
		SELECT FN_DIM_DEPARTMENT.DEPARTMENT_CODE
		, FN_DIM_DEPARTMENT.DEPARTMENT_SHORT_NAME
		, 'ผล' || ITEM_GROUP_NAME as TypeItemGroup
		, sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT) AS ACTUAL_AMOUNT
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
		and (LEVEL_LINE in ('2'))
		and (FISCAL_YEAR = (paramFnYear))
		and (ORGENIZATION_CODE = (paramFnOrg))
		and (DEPARTMENT_CODE in (paramFnDep) or 'All' in (paramFnDep))
		group by FN_DIM_DEPARTMENT.DEPARTMENT_CODE,DEPARTMENT_SHORT_NAME,ITEM_GROUP_NAME

		union

		SELECT FN_DIM_DEPARTMENT.DEPARTMENT_CODE
		, FN_DIM_DEPARTMENT.DEPARTMENT_SHORT_NAME
		, 'ผลค่าใช้จ่ายดำเนินการ' as TypeItemGroup
		, sum(FN_YEARLY_DEPARTMENT.ACTUAL_AMOUNT) AS ACTUAL_AMOUNT
		FROM FN_YEARLY_DEPARTMENT
		left join DIM_DATE on DIM_DATE.DATE_KEY = FN_YEARLY_DEPARTMENT.YEAR_KEY
		left join FN_DIM_DEPARTMENT on FN_DIM_DEPARTMENT.DEPARTMENT_KEY = FN_YEARLY_DEPARTMENT.DEPARTMENT_KEY
		where FN_YEARLY_DEPARTMENT.TEMPLATE_CODE = '10'
		and (LEVEL_LINE in ('2','3'))
		and (FISCAL_YEAR = (paramFnYear))
		and (ORGENIZATION_CODE = (paramFnOrg))
		and (DEPARTMENT_CODE in (paramFnDep) or 'All' in (paramFnDep))
		group by FN_DIM_DEPARTMENT.DEPARTMENT_CODE,DEPARTMENT_SHORT_NAME
		)kmutt		

		order by TypeItemGroup desc
		
	;        	
    OPEN  result_set_1;
END