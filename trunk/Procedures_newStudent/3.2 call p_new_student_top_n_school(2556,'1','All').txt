CREATE PROCEDURE p_new_student_top_n_school (IN paramYEAR INTEGER,IN paramSEMESTER VARCHAR(256),IN paramEDU VARCHAR(256),IN paramTOP INTEGER) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
select SCHOOL_NAME
,NO_OF_STUDENT
,ROWNUMBERS
from
(SELECT SCHOOL_NAME
,sum(NO_OF_STUDENT) as NO_OF_STUDENT
,row_number() over(order by sum(NO_OF_STUDENT) DESC) AS ROWNUMBERS
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' = (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' = (paramEDU))
group by DIM_SEMESTER.ACADEMIC_YEAR,SCHOOL_NAME
order by NO_OF_STUDENT DESC
)gj
where ROWNUMBERS <= (paramTOP);
OPEN result_set_1;
END