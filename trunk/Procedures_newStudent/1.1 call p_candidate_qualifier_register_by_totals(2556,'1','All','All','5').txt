CREATE PROCEDURE p_candidate_qualifier_register_by_totals (IN paramYEAR INTEGER,IN paramSEMESTER VARCHAR(256),IN paramEDU VARCHAR(256),IN paramADMTYPE VARCHAR(256),IN paramYEARSUB VARCHAR(256) ) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
select ACADEMIC_YEAR
,ADMISSIONTYPE
,TOTELADMISSION
from
(
SELECT DIM_SEMESTER.ACADEMIC_YEAR
,'ผู้สมัคร' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_CANDIDATE) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR between (paramYEAR)-(paramYEARSUB)+(1) and (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_SEMESTER.ACADEMIC_YEAR

union

SELECT DIM_SEMESTER.ACADEMIC_YEAR
,'ผู้มีสิทธิ์เข้าศึกษา' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_QUALIFIER) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR between (paramYEAR)-(paramYEARSUB)+(1) and (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_SEMESTER.ACADEMIC_YEAR

union

SELECT DIM_SEMESTER.ACADEMIC_YEAR
,'นักศึกษาลงทะเบียน' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_REGISTERED) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR between (paramYEAR)-(paramYEARSUB)+(1) and (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_SEMESTER.ACADEMIC_YEAR
)ADMISSION
order by ADMISSIONTYPE ,ACADEMIC_YEAR asc ;
    OPEN result_set_1;
END