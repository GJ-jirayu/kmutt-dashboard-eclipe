CREATE PROCEDURE p_new_student_by_school_table_region(IN paramYEAR INTEGER,IN paramSEMESTER VARCHAR(256),IN paramEDU VARCHAR(256),IN paramREG VARCHAR(256))
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR
select SCHOOL_NAME
,cast(TotalAdmission as varchar(100))
,cast(Totalplumb as varchar(100))
,cast(Totalspecifically as varchar(100))
,cast(Totalquota as varchar(100))
,cast((TotalAdmission + Totalplumb + Totalspecifically + Totalquota) as varchar(100)) as Total
from 
(
select FACT_PRE_ADMISSION.SCHOOL_NAME
, sum(Admission) 	as TotalAdmission
, sum(plumb)		as Totalplumb
, sum(specifically)	as Totalspecifically
, sum(quota)		as Totalquota
from
(
select DIM_SCHOOL.SCHOOL_NAME
,sum(NO_OF_STUDENT) as Admission
, 0 as plumb
, 0 as specifically
, 0 as quota
from FACT_PRE_ADMISSION_GRADE 
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_SCHOOL.REGION_CODE in (paramREG) or 'All' in (paramREG))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('1'))
group by DIM_SCHOOL.SCHOOL_NAME,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME

union

select DIM_SCHOOL.SCHOOL_NAME
, 0 as Admission
, sum(NO_OF_STUDENT) as plumb
, 0 as specifically
, 0 as quota
from FACT_PRE_ADMISSION_GRADE 
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_SCHOOL.REGION_CODE in (paramREG) or 'All' in (paramREG))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2'))
group by DIM_SCHOOL.SCHOOL_NAME,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME

union

select DIM_SCHOOL.SCHOOL_NAME
, 0  as Admission
, 0 as plumb
, sum(NO_OF_STUDENT) as specifically
, 0 as quota
from FACT_PRE_ADMISSION_GRADE 
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_SCHOOL.REGION_CODE in (paramREG) or 'All' in (paramREG))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('3'))
group by DIM_SCHOOL.SCHOOL_NAME,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME

union

select DIM_SCHOOL.SCHOOL_NAME
, 0 as Admission
, 0 as plumb
, 0 as specifically
, sum(NO_OF_STUDENT) as quota
from FACT_PRE_ADMISSION_GRADE 
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_SCHOOL.REGION_CODE in (paramREG) or 'All' in (paramREG))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('4'))
group by DIM_SCHOOL.SCHOOL_NAME,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME

)FACT_PRE_ADMISSION
group by FACT_PRE_ADMISSION.SCHOOL_NAME
)gj;

    OPEN result_set_1;
END
