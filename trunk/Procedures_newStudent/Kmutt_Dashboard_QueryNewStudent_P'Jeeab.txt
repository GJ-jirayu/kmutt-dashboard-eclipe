--  นักศึกษาใหม่_กราฟ 1.1 (กราฟแท่งกับเส้น) p_candidate_qualifier_register_by_total
select ACADEMIC_YEAR
,ADMISSIONTYPE
,TOTELADMISSION
from
(
SELECT DIM_SEMESTER.ACADEMIC_YEAR
,'ผู้สมัคร' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_CANDIDATE) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
where DIM_SEMESTER.ACADEMIC_YEAR between ('2555') and ('2556')
and DIM_SEMESTER.SEMESTER_CODE in ('1')
and DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001')
and DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2')
group by DIM_SEMESTER.ACADEMIC_YEAR

union

SELECT DIM_SEMESTER.ACADEMIC_YEAR
,'ผู้มีสิทธิ์เข้าศึกษา' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_QUALIFIER) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
where DIM_SEMESTER.ACADEMIC_YEAR between ('2555') and ('2556')
and DIM_SEMESTER.SEMESTER_CODE in ('1')
and DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001')
and DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2')
group by DIM_SEMESTER.ACADEMIC_YEAR

union

SELECT DIM_SEMESTER.ACADEMIC_YEAR
,'นักศึกษาลงทะเบียน' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_REGISTERED) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
where DIM_SEMESTER.ACADEMIC_YEAR between ('2555') and ('2556')
and DIM_SEMESTER.SEMESTER_CODE in ('1')
and DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001')
and DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2')
group by DIM_SEMESTER.ACADEMIC_YEAR
)ADMISSION
order by ACADEMIC_YEAR,ADMISSIONTYPE asc

-- นักศึกษาใหม่_กราฟ 1.2 (กราฟแท่งกับเส้น) p_candidate_qualifier_register_by_faculty
select FACULTY_NAME_INITIAL
,ADMISSIONTYPE
,TOTELADMISSION
from 
(SELECT DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,'ผู้สมัคร' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_CANDIDATE) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ADMISSION.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
--and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('All'))
group by DIM_SEMESTER.ACADEMIC_YEAR, DIM_FACULTY.FACULTY_CODE , DIM_FACULTY.FACULTY_NAME_INITIAL

union

SELECT DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,'ผู้มีสิทธิ์เข้าศึกษา' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_QUALIFIER) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ADMISSION.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
--and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('All'))
group by DIM_SEMESTER.ACADEMIC_YEAR, DIM_FACULTY.FACULTY_CODE , DIM_FACULTY.FACULTY_NAME_INITIAL

union
SELECT DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,'นักศึกษาลงทะเบียน' as ADMISSIONTYPE
,sum(FACT_ADMISSION.NO_OF_REGISTERED) as TOTELADMISSION
FROM FACT_ADMISSION
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ADMISSION.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_ADMISSION.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_ADMISSION.ADMISSION_TYPE_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ADMISSION.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
--and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('All'))
group by DIM_SEMESTER.ACADEMIC_YEAR, DIM_FACULTY.FACULTY_CODE , DIM_FACULTY.FACULTY_NAME_INITIAL
)
order by ADMISSIONTYPE, FACULTY_CODE

-- นักศึกษาใหม่_กราฟ 2.1 (กราฟแท่ง) p_new_student_by_faculty_and_admission_type
select gj.FACULTY_NAME_INITIAL
,gj.ADMISSION_TYPE_NAME
,DECIMAL(((DECIMAL(gj.NO_OF_STUDENT,8,2) * 100)/gj1.NO_OF_STUDENT),8,2) as Totalemploy
,gj.ADMISSION_TYPE_CODE
from 
(
SELECT DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME
,sum(FACT_NEW_STUDENT.NO_OF_STUDENT) as NO_OF_STUDENT
,DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE
FROM FACT_NEW_STUDENT
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_NEW_STUDENT.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_NEW_STUDENT.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_NEW_STUDENT.ADMISSION_TYPE_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_NEW_STUDENT.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME
,DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE
)gj
left join ( 
	SELECT DIM_FACULTY.FACULTY_CODE
	,sum(FACT_NEW_STUDENT.NO_OF_STUDENT) as NO_OF_STUDENT
	FROM FACT_NEW_STUDENT
	left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_NEW_STUDENT.SEMESTER_KEY
	left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_NEW_STUDENT.PROGRAM_KEY
	left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_NEW_STUDENT.ADMISSION_TYPE_KEY
	left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_NEW_STUDENT.FIELD_KEY
	left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
	where (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
	and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
	and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
	group by DIM_FACULTY.FACULTY_CODE
)gj1 on gj1.FACULTY_CODE = gj.FACULTY_CODE
order by gj.ADMISSION_TYPE_CODE,gj.FACULTY_CODE

-- นักศึกษาใหม่_กราฟ 2.2(กราฟแท่ง) p_new_student_by_faculty_and_grade_range
select FACULTY_NAME_INITIAL
,GRADE_RANGE_DESC
,DECIMAL(((DECIMAL(no_of_student,8,2) * 100)/of_student),8,2) as Totalemploy
from
(
SELECT '1' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_DESC
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE in ('1'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_CODE
,DIM_GRADE_RANGE.GRADE_RANGE_DESC

union

SELECT '2' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_DESC
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE not in ('1','N/A'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_CODE
,DIM_GRADE_RANGE.GRADE_RANGE_DESC

union

SELECT '3' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_DESC
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE in ('N/A'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_CODE
,DIM_GRADE_RANGE.GRADE_RANGE_DESC
)gj1

left join (
select FACULTY_CODE
,sum(no_of_student) as of_student
from
(
SELECT '1' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE in ('1'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL

union

SELECT '2' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE not in ('1','N/A'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL

union

SELECT '3' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE in ('N/A'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
)gj3
group by FACULTY_CODE

)gj2 on gj2.FACULTY_CODE = gj1.FACULTY_CODE

order by nos,gj1.FACULTY_CODE

-- นักศึกษาใหม่_กราฟ 2.3 (กราฟวงกลม) p_new_student_by_faculty
SELECT DIM_FACULTY.FACULTY_NAME_INITIAL
,sum(FACT_NEW_STUDENT.NO_OF_STUDENT) as NO_OF_STUDENT
FROM FACT_NEW_STUDENT
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_NEW_STUDENT.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_NEW_STUDENT.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_NEW_STUDENT.ADMISSION_TYPE_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_NEW_STUDENT.FIELD_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('1'))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
order by DIM_FACULTY.FACULTY_CODE
,NO_OF_STUDENT

-- นักศึกษาใหม่_กราฟ 3.1 (กราฟแท่งกับเส้น) p_new_student_vs_plan_by_year
select ACADEMIC_YEAR,ACTUALPLANTYPE,TOTELACTUALPLAN
from(
SELECT DIM_SEMESTER.ACADEMIC_YEAR 
,'จำนวนนักศึกษาใหม่' as ACTUALPLANTYPE
,sum(FACT_ACTUAL_PLAN.NO_OF_ACTUAL_NEW_STUDENT) as TOTELACTUALPLAN
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR between (2556)-(3)+(1) and (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_FOREIGN_FLAG.FOREIGN_FLAG in ('N'))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_SEMESTER.ACADEMIC_YEAR

union

SELECT DIM_SEMESTER.ACADEMIC_YEAR 
,'แผน' as ACTUALPLANTYPE
,sum(FACT_ACTUAL_PLAN.NO_OF_PLAN_NEW_STUDENT) as TOTELACTUALPLAN
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR between (2556)-(3)+(1) and (2556))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_FOREIGN_FLAG.FOREIGN_FLAG in ('N'))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_SEMESTER.ACADEMIC_YEAR
)ACTUAL_PLAN
order by ACTUALPLANTYPE,ACADEMIC_YEAR asc ; 

-- นักศึกษาใหม่_กราฟ 3.2 (กราฟวงกลม) p_new_student_top_n_school
SELECT SCHOOL_NAME
,sum(NO_OF_STUDENT) as NO_OF_STUDENT
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
where SCHOOL_NAME not in ('N/A')
and (DIM_SEMESTER.ACADEMIC_YEAR in ('2556'))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_SEMESTER.ACADEMIC_YEAR,SCHOOL_NAME
order by NO_OF_STUDENT DESC
FETCH FIRST 5 ROWS ONLY;

-- นักศึกษาใหม่_กราฟ 3.3 (กราฟแท่งกับเส้น) p_new_student_vs_plan_by_faculty
select ACTUAL_PLAN.FACULTY_NAME_INITIAL
,ACTUAL_PLAN.NEW_STUDENT_TYPE
,DECIMAL(((DECIMAL(ACTUAL_PLAN.NO_OF_NEW_STUDENT_ACTUAL_PLAN,8,2) * 100)/gj.total),8,2) as Total_NEW_STUDENT_ACTUAL_PLAN
from
(SELECT DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,'จำนวนนักศึกษาใหม่' as NEW_STUDENT_TYPE
,sum(FACT_ACTUAL_PLAN.NO_OF_ACTUAL_NEW_STUDENT) as NO_OF_NEW_STUDENT_ACTUAL_PLAN
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ACTUAL_PLAN.FIELD_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in ('2556'))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_FOREIGN_FLAG.FOREIGN_FLAG in ('N'))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_SEMESTER.ACADEMIC_YEAR
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL

union 

SELECT DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,'แผน' as NEW_STUDENT_TYPE
,sum(FACT_ACTUAL_PLAN.NO_OF_PLAN_NEW_STUDENT) as NO_OF_NEW_STUDENT_ACTUAL_PLAN
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ACTUAL_PLAN.FIELD_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in ('2556'))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_FOREIGN_FLAG.FOREIGN_FLAG in ('N'))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_SEMESTER.ACADEMIC_YEAR
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
) ACTUAL_PLAN
left join (
	select FACULTY_CODE
,sum(NO_OF_NEW_STUDENT_ACTUAL_PLAN) as total
from
(SELECT DIM_FACULTY.FACULTY_CODE
,sum(FACT_ACTUAL_PLAN.NO_OF_ACTUAL_NEW_STUDENT) as NO_OF_NEW_STUDENT_ACTUAL_PLAN
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ACTUAL_PLAN.FIELD_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in ('2556'))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_FOREIGN_FLAG.FOREIGN_FLAG in ('N'))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_FACULTY.FACULTY_CODE

union 

SELECT DIM_FACULTY.FACULTY_CODE
,sum(FACT_ACTUAL_PLAN.NO_OF_PLAN_NEW_STUDENT) as NO_OF_NEW_STUDENT_ACTUAL_PLAN
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ACTUAL_PLAN.FIELD_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR in ('2556'))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_FOREIGN_FLAG.FOREIGN_FLAG in ('N'))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_FACULTY.FACULTY_CODE
) ACTUAL_PLAN
group by FACULTY_CODE

)gj on gj.FACULTY_CODE  = ACTUAL_PLAN.FACULTY_CODE
order by ACTUAL_PLAN.NEW_STUDENT_TYPE,ACTUAL_PLAN.FACULTY_CODE

-- นักศึกษาใหม่_กราฟ 4.1 (กราฟส้น) p_new_student_by_year_and_faculty
SELECT DIM_SEMESTER.ACADEMIC_YEAR
,DIM_FACULTY.FACULTY_NAME_INITIAL
,sum(FACT_ACTUAL_PLAN.NO_OF_ACTUAL_NEW_STUDENT) as NO_OF_ACTUAL_NEW_STUDENT
FROM FACT_ACTUAL_PLAN
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_ACTUAL_PLAN.SEMESTER_KEY
left join DIM_EDUCATION_LEVEL on DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_KEY = FACT_ACTUAL_PLAN.EDUCATION_LEVEL_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_ACTUAL_PLAN.FIELD_KEY
left join DIM_FOREIGN_FLAG on DIM_FOREIGN_FLAG.FOREIGN_FLAG_KEY = FACT_ACTUAL_PLAN.FOREIGN_FLAG_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_SEMESTER.ACADEMIC_YEAR between ('2555')-(3)+(1) and ('2555'))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_FOREIGN_FLAG.FOREIGN_FLAG in ('N'))
and (DIM_EDUCATION_LEVEL.EDUCATION_LEVEL_CODE in ('001'))
group by DIM_SEMESTER.ACADEMIC_YEAR
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
order by DIM_FACULTY.FACULTY_CODE,DIM_SEMESTER.ACADEMIC_YEAR;

-- นักศึกษาใหม่_กราฟ 5.1 (ตาราง) p_new_student_by_school
select PROVINCE_CODE
,PROVINCE
,REGION_CODE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_PROVINCE,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_PROVINCE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_REGION,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_REGION
from
(select DIM_SCHOOL.PROVINCE_CODE,
DIM_SCHOOL.PROVINCE,
DIM_SCHOOL.REGION_CODE,
sum(NO_OF_STUDENT) as NO_OF_STUDENT_PROVINCE,
PRE.NO_OF_STUDENT_REGION,
(
select  sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = ('2555'))
        and (SEMESTER.SEMESTER_CODE in ('1'))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in ('002'))
) as total_NO_OF_STUDENT
from FACT_PRE_ADMISSION_GRADE
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join (
        select school.REGION_CODE,
        sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = ('2555'))
        and (SEMESTER.SEMESTER_CODE in ('1'))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in ('002'))
        group by school.REGION_CODE            
)PRE on PRE.REGION_CODE = DIM_SCHOOL.REGION_CODE
where (DIM_SCHOOL.PROVINCE_CODE not in ('N/A') and DIM_SCHOOL.PROVINCE_CODE not in (''))
and (DIM_SEMESTER.ACADEMIC_YEAR = ('2555'))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))  
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('002'))
group by DIM_SCHOOL.PROVINCE_CODE,DIM_SCHOOL.PROVINCE,DIM_SCHOOL.REGION_CODE,PRE.NO_OF_STUDENT_REGION
)gj

-- 5.2.2 ตารางจังหวัด
select SCHOOL_NAME
,TotalAdmission
,Totalplumb
,Totalspecifically
,Totalquota
,(TotalAdmission + Totalplumb + Totalspecifically + Totalquota) as Total
from 
(
select FACT_PRE_ADMISSION.SCHOOL_NAME
, sum(Admission) 	as TotalAdmission
, sum(plumb)		as Totalplumb
, sum(specifically)	as Totalspecifically
, sum(quota)		as Totalquota
from
(
select DIM_SCHOOL.SCHOOL_NAME
,sum(NO_OF_STUDENT) as Admission
, 0 as plumb
, 0 as specifically
, 0 as quota
from FACT_PRE_ADMISSION_GRADE 
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (2555))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('1'))
group by DIM_SCHOOL.SCHOOL_NAME,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME

union

select DIM_SCHOOL.SCHOOL_NAME
, 0 as Admission
, sum(NO_OF_STUDENT) as plumb
, 0 as specifically
, 0 as quota
from FACT_PRE_ADMISSION_GRADE 
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (2555))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('2'))
group by DIM_SCHOOL.SCHOOL_NAME,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME

union

select DIM_SCHOOL.SCHOOL_NAME
, 0  as Admission
, 0 as plumb
, sum(NO_OF_STUDENT) as specifically
, 0 as quota
from FACT_PRE_ADMISSION_GRADE 
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (2555))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('3'))
group by DIM_SCHOOL.SCHOOL_NAME,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME

union

select DIM_SCHOOL.SCHOOL_NAME
, 0 as Admission
, 0 as plumb
, 0 as specifically
, sum(NO_OF_STUDENT) as quota
from FACT_PRE_ADMISSION_GRADE 
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
where (DIM_SEMESTER.ACADEMIC_YEAR in (2555))
and (DIM_SEMESTER.SEMESTER_CODE in ('1'))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in ('001'))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in ('4'))
group by DIM_SCHOOL.SCHOOL_NAME,DIM_ADMISSION_TYPE.ADMISSION_TYPE_NAME

)FACT_PRE_ADMISSION
group by FACT_PRE_ADMISSION.SCHOOL_NAME
)gj

---5.1.2
select REGION_MAP_CODE
,REGION_MAP_NAME
,Total_REGION
,NO_OF_STUDENT_REGION
from
(
select DIM_MAP.REGION_MAP_CODE
,DIM_MAP.REGION_MAP_NAME
,gj2.Total_REGION
,NO_OF_STUDENT_REGION
from 

(select PROVINCE_CODE
,PROVINCE
,REGION_CODE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_PROVINCE,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_PROVINCE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_REGION,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_REGION
,NO_OF_STUDENT_PROVINCE
,NO_OF_STUDENT_REGION
from
(select DIM_SCHOOL.PROVINCE_CODE,
DIM_SCHOOL.PROVINCE,
DIM_SCHOOL.REGION_CODE,
sum(NO_OF_STUDENT) as NO_OF_STUDENT_PROVINCE,
PRE.NO_OF_STUDENT_REGION,
(
select  sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = (2556))
        and (SEMESTER.SEMESTER_CODE in (1))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in (001))
) as total_NO_OF_STUDENT
from FACT_PRE_ADMISSION_GRADE
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join (
        select school.REGION_CODE,
        sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = (2556))
        and (SEMESTER.SEMESTER_CODE in (1))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in (001))
        group by school.REGION_CODE            
)PRE on PRE.REGION_CODE = DIM_SCHOOL.REGION_CODE
where (DIM_SCHOOL.PROVINCE_CODE not in ('N/A') and DIM_SCHOOL.PROVINCE_CODE not in (''))
and (DIM_SEMESTER.ACADEMIC_YEAR = (2556))
and (DIM_SEMESTER.SEMESTER_CODE in (1))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (001))
group by DIM_SCHOOL.PROVINCE_CODE,DIM_SCHOOL.PROVINCE,DIM_SCHOOL.REGION_CODE,PRE.NO_OF_STUDENT_REGION
)gj
)gj2
left join COLOR COLOR_PROVINCE on gj2.Total_PROVINCE >= COLOR_PROVINCE.START_COLOR and gj2.Total_PROVINCE <= COLOR_PROVINCE.END_COLOR
left join COLOR COLOR_REGION on gj2.Total_REGION >= COLOR_REGION.START_COLOR and gj2.Total_REGION <= COLOR_REGION.END_COLOR
left join DIM_MAP on gj2.REGION_CODE = DIM_MAP.REGION_MAP_CODE
group by DIM_MAP.REGION_MAP_CODE
,DIM_MAP.REGION_MAP_NAME
,gj2.Total_REGION
,NO_OF_STUDENT_REGION

union

select 'All' as REGION_MAP_CODE
,'รวมทุกภาค' as REGION_MAP_NAME
,sum(Total_REGION) as Total_REGION
,sum(NO_OF_STUDENT_REGION) as NO_OF_STUDENT_REGION
from
(select DIM_MAP.REGION_MAP_NAME
,gj2.Total_REGION
,NO_OF_STUDENT_REGION
from 

(select PROVINCE_CODE
,PROVINCE
,REGION_CODE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_PROVINCE,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_PROVINCE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_REGION,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_REGION
,NO_OF_STUDENT_PROVINCE
,NO_OF_STUDENT_REGION
from
(select DIM_SCHOOL.PROVINCE_CODE,
DIM_SCHOOL.PROVINCE,
DIM_SCHOOL.REGION_CODE,
sum(NO_OF_STUDENT) as NO_OF_STUDENT_PROVINCE,
PRE.NO_OF_STUDENT_REGION,
(
select  sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = (2556))
        and (SEMESTER.SEMESTER_CODE in (1))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in (001))
) as total_NO_OF_STUDENT
from FACT_PRE_ADMISSION_GRADE
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join (
        select school.REGION_CODE,
        sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = (2556))
        and (SEMESTER.SEMESTER_CODE in (1))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in (001))
        group by school.REGION_CODE            
)PRE on PRE.REGION_CODE = DIM_SCHOOL.REGION_CODE
where (DIM_SCHOOL.PROVINCE_CODE not in ('N/A') and DIM_SCHOOL.PROVINCE_CODE not in (''))
and (DIM_SEMESTER.ACADEMIC_YEAR = (2556))
and (DIM_SEMESTER.SEMESTER_CODE in (1))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (001))
group by DIM_SCHOOL.PROVINCE_CODE,DIM_SCHOOL.PROVINCE,DIM_SCHOOL.REGION_CODE,PRE.NO_OF_STUDENT_REGION
)gj
)gj2
left join COLOR COLOR_PROVINCE on gj2.Total_PROVINCE >= COLOR_PROVINCE.START_COLOR and gj2.Total_PROVINCE <= COLOR_PROVINCE.END_COLOR
left join COLOR COLOR_REGION on gj2.Total_REGION >= COLOR_REGION.START_COLOR and gj2.Total_REGION <= COLOR_REGION.END_COLOR
left join DIM_MAP on gj2.REGION_CODE = DIM_MAP.REGION_MAP_CODE
group by
DIM_MAP.REGION_MAP_NAME
,gj2.Total_REGION
,NO_OF_STUDENT_REGION
)gj3
)gj4
where REGION_MAP_CODE = 'All';

---5.2.2
select PROVINCE_CODE
,PROVINCE
,NO_OF_STUDENT_PROVINCE
,Total_PROVINCE
from
(select gj2.PROVINCE_CODE
,gj2.PROVINCE
,NO_OF_STUDENT_PROVINCE
,gj2.Total_PROVINCE

from 

(select PROVINCE_CODE
,PROVINCE
,REGION_CODE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_PROVINCE,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_PROVINCE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_REGION,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_REGION
,NO_OF_STUDENT_PROVINCE
,NO_OF_STUDENT_REGION
from
(select DIM_SCHOOL.PROVINCE_CODE,
DIM_SCHOOL.PROVINCE,
DIM_SCHOOL.REGION_CODE,
sum(NO_OF_STUDENT) as NO_OF_STUDENT_PROVINCE,
PRE.NO_OF_STUDENT_REGION,
(
select  sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = (2556))
        and (SEMESTER.SEMESTER_CODE in (1))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in (001))
) as total_NO_OF_STUDENT
from FACT_PRE_ADMISSION_GRADE
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join (
        select school.REGION_CODE,
        sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = (2556))
        and (SEMESTER.SEMESTER_CODE in (1))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in (001))
        group by school.REGION_CODE            
)PRE on PRE.REGION_CODE = DIM_SCHOOL.REGION_CODE
where (DIM_SCHOOL.PROVINCE_CODE not in ('N/A') and DIM_SCHOOL.PROVINCE_CODE not in (''))
and (DIM_SEMESTER.ACADEMIC_YEAR = (2556))
and (DIM_SEMESTER.SEMESTER_CODE in (1))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (001))
group by DIM_SCHOOL.PROVINCE_CODE,DIM_SCHOOL.PROVINCE,DIM_SCHOOL.REGION_CODE,PRE.NO_OF_STUDENT_REGION
)gj
)gj2
left join COLOR COLOR_PROVINCE on gj2.Total_PROVINCE >= COLOR_PROVINCE.START_COLOR and gj2.Total_PROVINCE <= COLOR_PROVINCE.END_COLOR
left join COLOR COLOR_REGION on gj2.Total_REGION >= COLOR_REGION.START_COLOR and gj2.Total_REGION <= COLOR_REGION.END_COLOR
left join DIM_MAP on gj2.REGION_CODE = DIM_MAP.REGION_MAP_CODE
group by gj2.PROVINCE_CODE
,gj2.PROVINCE
,gj2.Total_PROVINCE
,NO_OF_STUDENT_PROVINCE

union

select 'All' as PROVINCE_CODE
,'รวมทุกจังหวัด' as PROVINCE
,sum(NO_OF_STUDENT_PROVINCE) as NO_OF_STUDENT_PROVINCE
,sum(Total_PROVINCE) as Total_PROVINCE

from 
(select gj2.PROVINCE_CODE
,gj2.PROVINCE
,NO_OF_STUDENT_PROVINCE
,gj2.Total_PROVINCE

from 

(select PROVINCE_CODE
,PROVINCE
,REGION_CODE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_PROVINCE,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_PROVINCE
,DECIMAL(((DECIMAL(NO_OF_STUDENT_REGION,8,2) * 100)/total_NO_OF_STUDENT),8,2) as Total_REGION
,NO_OF_STUDENT_PROVINCE
,NO_OF_STUDENT_REGION
from
(select DIM_SCHOOL.PROVINCE_CODE,
DIM_SCHOOL.PROVINCE,
DIM_SCHOOL.REGION_CODE,
sum(NO_OF_STUDENT) as NO_OF_STUDENT_PROVINCE,
PRE.NO_OF_STUDENT_REGION,
(
select  sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = (2556))
        and (SEMESTER.SEMESTER_CODE in (1))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in (001))
) as total_NO_OF_STUDENT
from FACT_PRE_ADMISSION_GRADE
left join DIM_SCHOOL on DIM_SCHOOL.SCHOOL_KEY = FACT_PRE_ADMISSION_GRADE.SCHOOL_KEY
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join (
        select school.REGION_CODE,
        sum(fact_pre.NO_OF_STUDENT) as NO_OF_STUDENT_REGION
        from FACT_PRE_ADMISSION_GRADE fact_pre
        left join DIM_SCHOOL school on school.SCHOOL_KEY = fact_pre.SCHOOL_KEY
        left join DIM_SEMESTER SEMESTER on SEMESTER.SEMESTER_KEY = fact_pre.SEMESTER_KEY
        left join DIM_PROGRAM PROGRAMS on PROGRAMS.PROGRAM_KEY = fact_pre.PROGRAM_KEY
        where (school.REGION_CODE not in ('N/A') and school.REGION_CODE not in (''))
        and (SEMESTER.ACADEMIC_YEAR = (2556))
        and (SEMESTER.SEMESTER_CODE in (1))
        and (PROGRAMS.EDUCATION_LEVEL_CODE in (001))
        group by school.REGION_CODE            
)PRE on PRE.REGION_CODE = DIM_SCHOOL.REGION_CODE
where (DIM_SCHOOL.PROVINCE_CODE not in ('N/A') and DIM_SCHOOL.PROVINCE_CODE not in (''))
and (DIM_SEMESTER.ACADEMIC_YEAR = (2556))
and (DIM_SEMESTER.SEMESTER_CODE in (1))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (001))
group by DIM_SCHOOL.PROVINCE_CODE,DIM_SCHOOL.PROVINCE,DIM_SCHOOL.REGION_CODE,PRE.NO_OF_STUDENT_REGION
)gj
)gj2
left join COLOR COLOR_PROVINCE on gj2.Total_PROVINCE >= COLOR_PROVINCE.START_COLOR and gj2.Total_PROVINCE <= COLOR_PROVINCE.END_COLOR
left join COLOR COLOR_REGION on gj2.Total_REGION >= COLOR_REGION.START_COLOR and gj2.Total_REGION <= COLOR_REGION.END_COLOR
left join DIM_MAP on gj2.REGION_CODE = DIM_MAP.REGION_MAP_CODE
group by gj2.PROVINCE_CODE
,gj2.PROVINCE
,gj2.Total_PROVINCE
,NO_OF_STUDENT_PROVINCE
)gj3
)gj4
where (PROVINCE_CODE = 'TH-1')