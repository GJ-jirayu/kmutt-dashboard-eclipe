CREATE PROCEDURE p_new_student_by_faculty_and_grade_range (IN paramYEAR INTEGER,IN paramSEMESTER VARCHAR(256),IN paramEDU VARCHAR(256) ,IN paramADMTYPE VARCHAR(256) ) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
BEGIN 
    DECLARE result_set_1 CURSOR WITH RETURN TO CLIENT FOR

select case when FACULTY_NAME_INITIAL = 'KMUTT' then 'อื่นๆ' else FACULTY_NAME_INITIAL end as FACULTY_NAME_INITIAL
,GRADE_RANGE_DESC
,CASE WHEN of_student != 0 THEN DECIMAL(((DECIMAL(no_of_student,8,2) * 100)/of_student),8,2) ELSE 0 END AS Totalemploy
from
(
SELECT '1' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_DESC
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE in ('1'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_CODE
,DIM_GRADE_RANGE.GRADE_RANGE_DESC

union

SELECT '2' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_DESC
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE not in ('1','N/A'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_CODE
,DIM_GRADE_RANGE.GRADE_RANGE_DESC

union

SELECT '3' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_DESC
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE in ('N/A'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,DIM_GRADE_RANGE.GRADE_RANGE_CODE
,DIM_GRADE_RANGE.GRADE_RANGE_DESC
)gj1

left join (
select FACULTY_CODE
,sum(no_of_student) as of_student
from
(
SELECT '1' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE in ('1'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL

union

SELECT '2' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE not in ('1','N/A'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL

union

SELECT '3' as nos
,DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
,Sum(FACT_PRE_ADMISSION_GRADE.no_of_student) as no_of_student
FROM FACT_PRE_ADMISSION_GRADE
left join DIM_SEMESTER on DIM_SEMESTER.SEMESTER_KEY = FACT_PRE_ADMISSION_GRADE.SEMESTER_KEY
left join DIM_FIELD on DIM_FIELD.FIELD_KEY = FACT_PRE_ADMISSION_GRADE.FIELD_KEY
left join DIM_PROGRAM on DIM_PROGRAM.PROGRAM_KEY = FACT_PRE_ADMISSION_GRADE.PROGRAM_KEY
left join DIM_ADMISSION_TYPE on DIM_ADMISSION_TYPE.ADMISSION_TYPE_KEY = FACT_PRE_ADMISSION_GRADE.ADMISSION_TYPE_KEY
left join DIM_GRADE_RANGE on DIM_GRADE_RANGE.GRADE_RANGE_KEY = FACT_PRE_ADMISSION_GRADE.GRADE_RANGE_KEY
left join DIM_FACULTY on DIM_FACULTY.FACULTY_CODE = DIM_FIELD.FACULTY_CODE
where (DIM_GRADE_RANGE.GRADE_RANGE_CODE in ('N/A'))
and (DIM_SEMESTER.ACADEMIC_YEAR in (paramYEAR))
and (DIM_SEMESTER.SEMESTER_CODE in (paramSEMESTER) or 'All' in (paramSEMESTER))
and (DIM_PROGRAM.EDUCATION_LEVEL_CODE in (paramEDU) or 'All' in (paramEDU))
and (DIM_ADMISSION_TYPE.ADMISSION_TYPE_CODE in (paramADMTYPE) or 'All' in (paramADMTYPE))
group by DIM_FACULTY.FACULTY_CODE
,DIM_FACULTY.FACULTY_NAME_INITIAL
)gj3
group by FACULTY_CODE

)gj2 on gj2.FACULTY_CODE = gj1.FACULTY_CODE
order by nos,GRADE_RANGE_DESC,gj1.FACULTY_CODE;
	
    OPEN result_set_1;
END